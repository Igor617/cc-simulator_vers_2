<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>2D Симулятор колл-центра — ACW fix (v4.7)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{--bg:#0c1117;--panel:#111827;--ink:#e5e7eb;--ink2:#94a3b8;--accent:#22c55e;--accent2:#16a34a;--danger:#ef4444;--wait:#f59e0b;--blue:#3b82f6}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{display:flex;flex-direction:column;gap:12px;max-width:1280px;margin:0 auto;padding:16px}
  .controls{display:grid;gap:14px;background:var(--panel);padding:12px;border-radius:12px}
  .inputs{display:grid;gap:16px 24px}
  @media (min-width:1280px){ .inputs{grid-template-columns:repeat(3, 1fr)} }
  @media (min-width:900px) and (max-width:1279px){ .inputs{grid-template-columns:repeat(2, 1fr)} }
  @media (max-width:899px){ .inputs{grid-template-columns:1fr} }
  .field{display:flex;flex-direction:column;gap:8px;min-height:74px}
  .label{font-size:12px;color:var(--ink2)}
  .controls input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #1f2937;background:#0b1220;color:var(--ink);box-sizing:border-box;min-height:40px}
  .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .btn{cursor:pointer;border:1px solid #1f2937;background:#0b1220;color:#fff;padding:10px 14px;border-radius:14px;text-align:center;user-select:none;min-width:112px}
  .btn.primary{background:var(--accent);border-color:var(--accent2);color:#052e12;font-weight:700}
  .btn.stop{background:#7f1d1d;border-color:#991b1b}
  .btn.ghost{background:transparent;border-color:#334155}
  .speed{display:flex;gap:10px;flex-wrap:wrap}
  .speed .chip{padding:8px 12px;border:1px solid #1e3a8a;background:#172554;border-radius:12px;min-width:44px;text-align:center;cursor:pointer;user-select:none;color:#cbd5e1}
  .speed .chip.active{background:#3b82f6;border-color:#2563eb;color:#021025;font-weight:700}
  .stage{background:var(--panel);border-radius:14px;padding:10px;position:relative;overflow:hidden}
  .legend{position:absolute;right:10px;top:10px;font-size:12px;color:#cbd5e1;display:flex;gap:14px;pointer-events:none}
  .dot{width:10px;height:10px;border-radius:50%}
  .q{background:var(--danger)} .s{background:var(--blue)} .a{background:var(--wait)}
  svg{width:100%;height:440px;border-radius:10px;display:block;background:#0b1220}
</style>
</head>
<body>
<div class="wrap">
  <h1>2D Симулятор колл-центра — ACW fix (v4.7)</h1>
  <div class="controls">
    <div class="inputs">
      <div class="field"><div class="label">Входящие в час (λ)</div><input type="number" id="inpLambda" value="360"></div>
      <div class="field"><div class="label">AHT, сек</div><input type="number" id="inpAHT" value="540"></div>
      <div class="field"><div class="label">ACW, сек</div><input type="number" id="inpACW" value="60"></div>
      <div class="field"><div class="label">SLA, %</div><input type="number" id="inpSLA" value="80"></div>
      <div class="field"><div class="label">T, сек</div><input type="number" id="inpThresh" value="20"></div>
      <div class="field"><div class="label">Макс. занятость, %</div><input type="number" id="inpOccMax" value="85"></div>
      <div class="field"><div class="label">Шринкаж, %</div><input type="number" id="inpShrink" value="20"></div>
      <div class="field"><div class="label">Сотрудники (N)</div><input type="number" id="inpN" value="12"></div>
    </div>
    <div class="actions">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <div class="btn primary" id="btnStart">Запустить ▶</div>
        <div class="btn stop" id="btnStop">Остановить ■</div>
        <div class="btn ghost" id="btnReset">Сброс</div>
      </div>
      <div class="speed" id="speed">
        <div class="chip active" data-speed="1">x1</div>
        <div class="chip" data-speed="2">x2</div>
        <div class="chip" data-speed="4">x4</div>
        <div class="chip" data-speed="8">x8</div>
      </div>
    </div>
  </div>

  <div class="stage">
    <svg id="sim" viewBox="0 0 1280 440" preserveAspectRatio="xMidYMid meet">
      <g id="gSource"><circle cx="80" cy="220" r="44" fill="none" stroke="#22c55e" stroke-width="4"/><text x="80" y="225" text-anchor="middle" fill="#e2e8f0" font-size="14">вход</text><text id="txtLambda" x="80" y="250" text-anchor="middle" fill="#94a3b8" font-size="12">λ=360/ч</text></g>
      <g id="gQueue"><rect x="150" y="40" width="300" height="360" rx="8" fill="#121b26" stroke="#245" stroke-width="3"/><text id="labelQueue" x="160" y="34" fill="#cbd5e1" font-size="14">В очереди: 0</text></g>
      <g id="gService"><rect x="480" y="40" width="420" height="360" rx="8" fill="#0f2314" stroke="#256a3f" stroke-width="3"/><text id="labelService" x="490" y="34" fill="#cbd5e1" font-size="14">В работе: 0 / 0</text></g>
      <g id="gACW"><rect x="930" y="40" width="280" height="360" rx="8" fill="#221a0a" stroke="#a16207" stroke-width="3"/><text id="labelACW" x="940" y="34" fill="#cbd5e1" font-size="14">Пост-обработка: 0</text></g>
      <g id="gDone"><circle cx="1240" cy="220" r="44" fill="none" stroke="#22c55e" stroke-width="4"/><text x="1240" y="218" text-anchor="middle" fill="#e2e8f0" font-size="14">готово</text><text id="txtDoneNum" x="1240" y="246" text-anchor="middle" fill="#94a3b8" font-size="12">0</text></g>
    </svg>
  </div>
</div>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  const svgns="http://www.w3.org/2000/svg";
  const rndExp=m=>-m*Math.log(1-Math.random());
  const clamp=(v,mi,ma)=>Math.max(mi,Math.min(ma,v));

  let running=false, speedMul=1;
  const baseScale=60, fixedHz=30, fixedRealDt=1/fixedHz;
  let acc=0, lastTs=0, simT=0, nextArrival=0;

  const dots=new Set(); let idSeq=1, doneCount=0;
  let params={lambda:360,aht:540,acw:60,sla:80,thr:20,occMax:85,shrink:20,N:12};
  let staff=[], NActive=0;

  const areas={queue:{x:150,y:40,w:300,h:360,color:'#ef4444'},
               service:{x:480,y:40,w:420,h:360,color:'#3b82f6'},
               acw:{x:930,y:40,w:280,h:360,color:'#f59e0b'}};

  const svg=$('#sim'), gService=$('#gService'),
        labelQueue=$('#labelQueue'), labelService=$('#labelService'), labelACW=$('#labelACW'),
        txtLambda=$('#txtLambda'), txtDoneNum=$('#txtDoneNum');

  const queueSlots=[]; let qCols=0,qRows=0,qCell=16;
  function buildQueueGrid(){ qCols=Math.floor((areas.queue.w-20)/qCell); qRows=Math.floor((areas.queue.h-20)/qCell); queueSlots.length=qCols*qRows; queueSlots.fill(null); }
  function slotCoord(i){ const c=i%qCols, r=Math.floor(i/qCols); return {x:areas.queue.x+10+c*qCell+qCell*.5, y:areas.queue.y+10+r*qCell+qCell*.5}; }
  function nextFreeSlot(){ for(let i=0;i<queueSlots.length;i++) if(!queueSlots[i]) return i; return null }

  function buildStaff(){
    Array.from(gService.querySelectorAll('.agent')).forEach(n=>n.remove()); staff.length=0;
    const N=params.N|0, cols=Math.min(8,Math.max(3,Math.ceil(Math.sqrt(Math.max(1,N))))) , rows=Math.ceil(Math.max(1,N)/cols);
    const pad=12, cellW=(areas.service.w-pad*2)/cols, cellH=(areas.service.h-pad*2)/rows;
    for(let i=0;i<N;i++){
      const c=i%cols,r=Math.floor(i/cols),x=areas.service.x+pad+c*cellW+cellW*.5,y=areas.service.y+pad+r*cellH+cellH*.5;
      const g=document.createElementNS(svgns,'g'); g.classList.add('agent');
      const circle=document.createElementNS(svgns,'circle'); circle.setAttribute('cx',x); circle.setAttribute('cy',y); circle.setAttribute('r',14);
      circle.setAttribute('fill','#0b1220'); circle.setAttribute('stroke','#16a34a'); circle.setAttribute('stroke-width','2');
      g.appendChild(circle); gService.appendChild(g);
      staff.push({id:i+1,state:'idle',el:g,x,y,busyUntil:0,acwUntil:null});
    }
    NActive=Math.max(0,Math.round(N*(1-params.shrink/100)));
    staff.forEach((a,i)=>{ if(i<NActive){a.state='idle'; a.el.style.opacity=1}else{a.state='break'; a.el.style.opacity=.25} });
    updateServiceLabel();
  }

  function setParams(){ params.lambda=+$('#inpLambda').value; params.aht=+$('#inpAHT').value; params.acw=+$('#inpACW').value; params.N=+$('#inpN').value; txtLambda.textContent=`λ=${params.lambda}/ч`; buildStaff(); }
  function mkDot(x,y,color){ const c=document.createElementNS(svgns,'circle'); c.setAttribute('cx',x); c.setAttribute('cy',y); c.setAttribute('r',5); c.setAttribute('fill',color); svg.appendChild(c); return c }
  function updateServiceLabel(){ const busy=staff.filter(s=>s.state==='busy').length; labelService.textContent=`В работе: ${busy} / ${params.N} (активно: ${NActive})` }
  function updateCounters(){ labelQueue.textContent=`В очереди: ${[...dots].filter(d=>d.state==='inQueue').length}`;
    labelACW.textContent=`Пост-обработка: ${[...dots].filter(d=>d.state==='inACW'||d.state==='toACW').length}`; updateServiceLabel(); txtDoneNum.textContent=doneCount }

  function spawnToQueue(){
    const sx=80, sy=220; const idx=nextFreeSlot(); if(idx!=null) queueSlots[idx]='RES';
    const target=idx!=null?slotCoord(idx):{x:areas.queue.x+areas.queue.w-15,y:areas.queue.y+areas.queue.h-15};
    const el=mkDot(sx,sy,areas.queue.color);
    const d={id:idSeq++,el,state:'toQueue',x:sx,y:sy,target,enterQueueAt:0,enterServiceAt:0,enterACWAt:0,assigned:null,qSlot:idx,acwEndAt:null};
    dots.add(d);
  }

  function scheduleArrivals(tEnd){
    const ratePerSec=params.lambda/3600;
    while(nextArrival<=tEnd){ spawnToQueue(); nextArrival=(nextArrival||simT)+Math.max(1,rndExp(1/ratePerSec)); }
  }

  function tryAssign(){
    const waiting=[...dots].filter(d=>d.state==='inQueue').sort((a,b)=>a.enterQueueAt-b.enterQueueAt)[0];
    if(!waiting) return false;
    const agent=staff.find(a=>a.state==='idle');
    if(!agent) return false;
    waiting.state='toService'; waiting.target={x:agent.x,y:agent.y}; waiting.el.setAttribute('fill',areas.service.color); waiting.assigned=agent;
    agent.state='busy'; agent.busyUntil=simT+Math.max(1,rndExp(params.aht));
    if(waiting.qSlot!=null){ queueSlots[waiting.qSlot]=null; waiting.qSlot=null; }
    updateServiceLabel(); return true;
  }

  function step(realDt){
    if(!running) return;
    const simDt=realDt*baseScale*speedMul, tEnd=simT+simDt;
    scheduleArrivals(tEnd);

    const moveSpeed=120;
    dots.forEach(d=>{
      if(d.state==='toQueue'||d.state==='toService'||d.state==='toACW'){
        const dx=d.target.x-d.x, dy=d.target.y-d.y, dist=Math.hypot(dx,dy), stepLen=Math.min(dist,moveSpeed*realDt*2);
        if(dist<=0.5){
          if(d.state==='toQueue'){ d.state='inQueue'; d.enterQueueAt=simT; if(d.qSlot!=null) queueSlots[d.qSlot]=d; }
          else if(d.state==='toService'){ d.state='inService'; d.enterServiceAt=simT; }
          else if(d.state==='toACW'){ d.state='inACW'; d.enterACWAt=simT; d.acwEndAt=simT+Math.max(1,rndExp(params.acw||1)); if(d.assigned && d.assigned.state==='acw'){ d.assigned.acwUntil=d.acwEndAt; } }
          d.x=d.target.x; d.y=d.target.y;
        }else{ d.x+=(dx/dist)*stepLen; d.y+=(dy/dist)*stepLen; }
        d.el.setAttribute('cx',d.x); d.el.setAttribute('cy',d.y);
      }
      if(d.state==='inACW' && d.acwEndAt && simT>=d.acwEndAt){
        d.el.remove(); dots.delete(d); doneCount++; if(d.assigned){ d.assigned.state='idle'; d.assigned.acwUntil=null; }
      }
    });

    staff.forEach(ag=>{
      if(ag.state==='busy' && simT+simDt>=ag.busyUntil){
        const d=[...dots].find(o=>o.assigned===ag&&o.state==='inService'); if(d){
          d.state='toACW'; d.el.setAttribute('fill',areas.acw.color);
          d.target={x:areas.acw.x+10+Math.random()*(areas.acw.w-20), y:areas.acw.y+10+Math.random()*(areas.acw.h-20)};
        }
        ag.state='acw'; ag.acwUntil=null; // таймер ACW стартует после фактического входа точки в прямоугольник
      }
    });

    while(tryAssign()) {}
    simT=tEnd; updateCounters();
  }

  function loop(ts){ if(!lastTs) lastTs=ts; let d=(ts-lastTs)/1000; if(d>0.25) d=0.25; lastTs=ts; acc+=d; while(acc>=fixedRealDt){ step(fixedRealDt); acc-=fixedRealDt } requestAnimationFrame(loop) }
  requestAnimationFrame(loop);

  // UI
  ['#inpLambda','#inpAHT','#inpACW','#inpN'].forEach(id=>$(id).addEventListener('change',()=>{ if(!running) setParams() }));
  $('#speed').addEventListener('click',e=>{ const b=e.target.closest('.chip'); if(!b) return; $('#speed').querySelectorAll('.chip').forEach(n=>n.classList.remove('active')); b.classList.add('active'); speedMul=+b.dataset.speed; });
  $('#btnStart').addEventListener('click',()=>{ if(running) return; dots.forEach(d=>d.el.remove()); dots.clear(); doneCount=0; simT=0; acc=0; lastTs=0; nextArrival=0; buildQueueGrid(); buildStaff(); running=true; updateCounters(); });
  $('#btnStop').addEventListener('click',()=>{ running=false });
  $('#btnReset').addEventListener('click',()=>{ running=false; dots.forEach(d=>d.el.remove()); dots.clear(); doneCount=0; simT=0; acc=0; lastTs=0; nextArrival=0; updateCounters(); });

  setParams(); buildQueueGrid(); buildStaff(); updateCounters();
})();
</script>
</body>
</html>
