<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>2D Симулятор колл-центра — табличная выгрузка (v4.2)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
	:root{
		--bg:#0c1117; --panel:#111827; --muted:#334155; --ink:#e5e7eb; --ink2:#94a3b8;
		--accent:#22c55e; --accent2:#16a34a; --danger:#ef4444; --wait:#f59e0b; --blue:#3b82f6;
	}
	html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
	.wrap{display:flex;flex-direction:column;gap:10px;max-width:1200px;margin:0 auto;padding:14px}
	h1{font-size:18px;margin:0 0 6px 0;font-weight:600;letter-spacing:.2px}

	.controls{display:grid;gap:14px;background:var(--panel);padding:12px;border-radius:12px}
	/* Responsive inputs grid: auto-wrap with safe min width and larger gaps */
	.inputs{
		display:grid;
		grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
		column-gap:24px;
		row-gap:16px;
		align-items:start;
	}
	.field{display:flex;flex-direction:column;gap:8px;min-height:74px}
	.controls label{display:block;font-size:12px;color:var(--ink2);line-height:1.2;word-break:break-word;hyphens:auto}
	.controls input{
		width:100%;padding:10px 12px;border-radius:10px;border:1px solid #1f2937;
		background:#0b1220;color:var(--ink);box-sizing:border-box;display:block;min-height:40px
	}
	.actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:6px}
	.btn{cursor:pointer;border:1px solid #1f2937;background:#0b1220;color:var(--ink);padding:10px 14px;border-radius:14px;text-align:center;user-select:none;min-width:112px}
	.btn:hover{background:#0e172a}
	.btn.primary{background:var(--accent);border-color:var(--accent2);color:#052e12;font-weight:700}
	.btn.stop{background:#7f1d1d;border-color:#991b1b}
	.btn.ghost{background:transparent;border-color:#334155}
	.speed{display:flex;gap:10px;flex-wrap:wrap}
	.speed .chip{padding:8px 12px;border:1px solid #1e3a8a;background:#172554;border-radius:12px;min-width:44px;text-align:center;cursor:pointer;user-select:none}
	.speed .chip.active{background:#3b82f6;border-color:#2563eb;color:#021025;font-weight:700}

	.stage{background:var(--panel);border-radius:14px;padding:10px;position:relative;overflow:hidden}
	.legend{position:absolute;right:10px;top:10px;font-size:12px;color:var(--ink2);display:flex;gap:14px}
	.legend span{display:inline-flex;align-items:center;gap:6px}
	.dot{width:10px;height:10px;border-radius:50%}
	.q{background:var(--danger)} .s{background:var(--blue)} .a{background:var(--wait)}
	svg{width:100%;height:420px;border-radius:10px;display:block;background:#0b1220}
	.title{position:absolute;left:14px;top:10px;font-size:13px;color:#cbd5e1}

	.tableBox{display:none;background:var(--panel);border-radius:12px;padding:10px}
	.tableBar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
	.tableBar .left{display:flex;gap:8px;align-items:center}
	.tableBar .right{display:flex;gap:8px;align-items:center}
	.small{font-size:12px;color:#94a3b8}

	table{width:100%;border-collapse:separate;border-spacing:0;background:#0b1220;border-radius:10px;overflow:hidden}
	thead th{position:sticky;top:0;background:#0f172a;color:#cbd5e1;font-weight:600;font-size:12px;padding:8px;border-bottom:1px solid #1f2937;white-space:nowrap}
	tbody td{padding:8px;border-bottom:1px solid #1f2937;color:#e5e7eb;font-variant-numeric:tabular-nums}
	tbody tr:nth-child(odd){background:#0b1220}
	tbody tr:nth-child(even){background:#0c1424}
	.scrollWrap{max-height:420px;overflow:auto;border:1px solid #1f2937;border-radius:10px}

	.pill{border:1px solid #334155;border-radius:10px;padding:6px 10px;cursor:pointer;background:#0b1220;color:#e5e7eb}
	.pill:hover{background:#0e172a}

	/* Extra safety on very narrow viewports */
	@media (max-width: 640px){
		.inputs{grid-template-columns: 1fr;}
	}
</style>
</head>
<body>
<div class="wrap">
	<h1>2D Симулятор колл-центра — табличная выгрузка</h1>
	<div class="controls">
		<div class="inputs">
			<div class="field"><label>Входящие звонки в час (λ)</label><input type="number" id="inpLambda" value="360" min="0" step="1"></div>
			<div class="field"><label>Средняя длительность контакта, сек (AHT)</label><input type="number" id="inpAHT" value="540" min="1" step="1"></div>
			<div class="field"><label>Пост-обработка, сек (ACW)</label><input type="number" id="inpACW" value="60" min="0" step="1"></div>
			<div class="field"><label>Целевой SLA, % (в пределах T)</label><input type="number" id="inpSLA" value="80" min="1" max="100" step="1"></div>
			<div class="field"><label>Порог ожидания T, сек</label><input type="number" id="inpThresh" value="20" min="0" step="1"></div>
			<div class="field"><label>Макс. загруженность, %</label><input type="number" id="inpOccMax" value="85" min="10" max="100" step="1"></div>
			<div class="field"><label>Шринкаж, %</label><input type="number" id="inpShrink" value="20" min="0" max="90" step="1"></div>
			<div class="field"><label>Количество сотрудников (N)</label><input type="number" id="inpN" value="12" min="0" step="1"></div>
		</div>
		<div class="actions">
			<div class="btn primary" id="btnStart">Запустить ▶</div>
			<div class="btn stop" id="btnStop">Остановить ■</div>
			<div class="btn ghost" id="btnReset">Сброс</div>
			<div class="speed" id="speed">
				<div class="chip active" data-speed="1">x1</div>
				<div class="chip" data-speed="2">x2</div>
				<div class="chip" data-speed="4">x4</div>
				<div class="chip" data-speed="8">x8</div>
			</div>
		</div>
		<div class="small">1 сим-час = 1 реальная минута. Ускорение x2/x4/x8 влияет на весь процесс.</div>
	</div>

	<div class="stage">
		<div class="title">Визуал области симуляции</div>
		<div class="legend">
			<span><i class="dot q"></i>Очередь</span>
			<span><i class="dot s"></i>Разговор</span>
			<span><i class="dot a"></i>Пост-обработка</span>
		</div>
		<svg id="sim" viewBox="0 0 1200 420" preserveAspectRatio="xMidYMid meet">
			<g id="gSource">
				<circle cx="70" cy="210" r="44" fill="none" stroke="#22c55e" stroke-width="4"/>
				<text x="70" y="215" text-anchor="middle" fill="#e2e8f0" font-size="14">вход</text>
				<text id="txtLambda" x="70" y="240" text-anchor="middle" fill="#94a3b8" font-size="12">λ=360/ч</text>
			</g>
			<g id="gQueue">
				<rect x="130" y="30" width="300" height="360" rx="8" fill="#121b26" stroke="#245" stroke-width="3"/>
				<text id="labelQueue" x="140" y="24" fill="#cbd5e1" font-size="14">В очереди: 0</text>
			</g>
			<g id="gService">
				<rect x="450" y="30" width="400" height="360" rx="8" fill="#0f2314" stroke="#256a3f" stroke-width="3"/>
				<text id="labelService" x="460" y="24" fill="#cbd5e1" font-size="14">В работе: 0 / 0</text>
			</g>
			<g id="gACW">
				<rect x="870" y="30" width="220" height="360" rx="8" fill="#221a0a" stroke="#a16207" stroke-width="3"/>
				<text id="labelACW" x="880" y="24" fill="#cbd5e1" font-size="14">Пост-обработка: 0</text>
			</g>
			<!-- final circle moved further right but kept inside viewBox -->
			<g id="gDone">
				<circle cx="1156" cy="210" r="44" fill="none" stroke="#22c55e" stroke-width="4"/>
				<text x="1156" y="208" text-anchor="middle" fill="#e2e8f0" font-size="14">готово</text>
				<text id="txtDoneNum" x="1156" y="236" text-anchor="middle" fill="#94a3b8" font-size="12">0</text>
			</g>
		</svg>
	</div>

	<div class="tableBox" id="tableBox">
		<div class="tableBar">
			<div class="left">
				<strong>Таблица метрик по минутам</strong>
				<span class="small" id="rowsCount"></span>
			</div>
			<div class="right">
				<button class="pill" id="btnCsv">Экспорт CSV</button>
				<button class="pill" id="btnXlsx">Экспорт XLSX</button>
			</div>
		</div>
		<div class="scrollWrap">
			<table id="tbl">
				<thead>
					<tr>
						<th>Время (сим.)</th>
						<th>Пришло</th>
						<th>В очереди</th>
						<th>В разговоре</th>
						<th>В пост-обработке</th>
						<th>Отвечено</th>
						<th>Отвечено ≤T</th>
						<th>Завершено</th>
						<th>ASA, мин</th>
						<th>Средний AHT, мин</th>
						<th>Среднее ожид., мин</th>
						<th>Уровень сервиса, %</th>
						<th>Активные сотрудники</th>
						<th>Занятость, %</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		</div>
		<div class="small" style="margin-top:6px">ASA и «Среднее ожид.» считаются по вызовам, начавшим обслуживание в интервале. Занятость — доля занятости активных агентов за минуту.</div>
	</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
(function(){
	const $ = s=>document.querySelector(s);
	const svgns = "http://www.w3.org/2000/svg";
	function rndExp(mean){return -mean * Math.log(1-Math.random());}
	function clamp(v,mi,ma){return Math.max(mi,Math.min(ma,v));}
	function pad2(n){return String(n).padStart(2,'0');}
	function fmtHM(secs){const h=Math.floor(secs/3600);const m=Math.floor((secs%3600)/60);return pad2(h)+':'+pad2(m);}

	let running=false, speedMul=1;
	// Backend integration: keep visual on client, move calculations to server
	const useBackend = true;
	let backendAccum = 0; // seconds to batch API step calls
	async function api(path, options={}){
		const res = await fetch(path, { headers:{ 'Content-Type': 'application/json' }, ...options });
		if(!res.ok) throw new Error(`API ${path} ${res.status}`);
		return res.json();
	}
	function getParams(){
		return {
			lambda:+$('#inpLambda').value,
			aht:+$('#inpAHT').value,
			acw:+$('#inpACW').value,
			sla:+$('#inpSLA').value,
			thr:+$('#inpThresh').value,
			occMax:+$('#inpOccMax').value,
			shrink:+$('#inpShrink').value,
			N:+$('#inpN').value
		};
	}
	const baseScale=60;
	let simT=0, nextArrival=0, lastTs=0;
	const dots=new Set();
	let idSeq=1;

	let params={lambda:360,aht:540,acw:60,sla:80,thr:20,occMax:85,shrink:20,N:12};
	let staff=[]; let NActive=0;

	let logEvery=60, nextLogAt=logEvery;
	const logs={ t:[], arrivals:[], q:[], talk:[], acw:[],
		answered:[], answeredInT:[], completed:[], staffActive:[], occ:[], asaMin:[], ahtMin:[], waitMin:[] };
	const tmpMinute={ finishedDur:[], waitDur:[], busyAgentsTime:0, activeAgentsTime:0, arrivals:0, answered:0, answeredInT:0, completed:0 };

	const svg=$('#sim'); const gService=$('#gService');
	const labelQueue=$('#labelQueue'); const labelService=$('#labelService'); const labelACW=$('#labelACW');
	const txtLambda=$('#txtLambda'); const txtDoneNum=$('#txtDoneNum');

	const areas={ queue:{x:130,y:30,w:300,h:360,color:'#ef4444'},
								service:{x:450,y:30,w:400,h:360,color:'#3b82f6'},
								acw:{x:870,y:30,w:220,h:360,color:'#f59e0b'} };
	let doneCount=0;

	function buildStaff(){
		Array.from(gService.querySelectorAll('.agent')).forEach(n=>n.remove()); staff.length=0;
		const N=params.N|0;
		const cols=Math.min(8,Math.max(3,Math.ceil(Math.sqrt(Math.max(1,N)))));
		const rows=Math.ceil(Math.max(1,N)/cols);
		const pad=12, cellW=(areas.service.w-pad*2)/cols, cellH=(areas.service.h-pad*2)/rows;
		for(let i=0;i<N;i++){
			const c=i%cols, r=Math.floor(i/cols);
			const x=areas.service.x+pad+c*cellW+cellW*.5, y=areas.service.y+pad+r*cellH+cellH*.5;
			const g=document.createElementNS(svgns,'g'); g.classList.add('agent');
			const circle=document.createElementNS(svgns,'circle'); circle.setAttribute('cx',x); circle.setAttribute('cy',y); circle.setAttribute('r',14);
			circle.setAttribute('fill','#0b1220'); circle.setAttribute('stroke','#16a34a'); circle.setAttribute('stroke-width','2'); g.appendChild(circle);
			gService.appendChild(g); staff.push({id:i+1,state:'idle',el:g,x,y,busyUntil:0,acwUntil:0});
		}
		NActive=Math.max(0,Math.round(N*(1-params.shrink/100)));
		staff.forEach((ag,i)=>{ if(i<NActive){ag.state='idle';ag.el.style.opacity=1}else{ag.state='break';ag.el.style.opacity=.25} });
		updateServiceLabel();
	}
	function updateServiceLabel(){ const busy=staff.filter(s=>s.state==='busy').length; labelService.textContent=`В работе: ${busy} / ${params.N} (активно: ${NActive})`; }
	function setParamsFromInputs(){
		params.lambda=+$('#inpLambda').value;
		params.aht=clamp(+$('#inpAHT').value,1,7200);
		params.acw=clamp(+$('#inpACW').value,0,3600);
		params.sla=clamp(+$('#inpSLA').value,1,100);
		params.thr=clamp(+$('#inpThresh').value,0,600);
		params.occMax=clamp(+$('#inpOccMax').value,1,100);
		params.shrink=clamp(+$('#inpShrink').value,0,90);
		params.N=Math.max(0,+$('#inpN').value|0);
		txtLambda.textContent=`λ=${params.lambda}/ч`; buildStaff();
	}

	function mkDot(x,y,color){ const c=document.createElementNS(svgns,'circle'); c.setAttribute('cx',x); c.setAttribute('cy',y); c.setAttribute('r',5); c.setAttribute('fill',color); svg.appendChild(c); return c; }
	function spawnToQueue(){
		const sx=70, sy=210; const dx=areas.queue.x+10+Math.random()*(areas.queue.w-20); const dy=areas.queue.y+10+Math.random()*(areas.queue.h-20);
		const el=mkDot(sx,sy,areas.queue.color);
		dots.add({id:idSeq++,el,state:'toQueue',x:sx,y:sy,target:{x:dx,y:dy},createdAt:simT,enterQueueAt:0,enterServiceAt:0,leaveServiceAt:0,enterACWAt:0});
		tmpMinute.arrivals++;
	}
	function tryAssign(){
		const waiting=[...dots].find(d=>d.state==='inQueue'); if(!waiting) return false;
		const agent=staff.find(a=>a.state==='idle'); if(!agent) return false;
		waiting.state='toService'; waiting.target={x:agent.x,y:agent.y}; waiting.el.setAttribute('fill',areas.service.color); waiting.assigned=agent;
		agent.state='busy'; agent.busyUntil=simT+Math.max(1,rndExp(params.aht)); updateServiceLabel(); return true;
	}

	function minuteLog(){
		logs.t.push(simT);
		const q=[...dots].filter(d=>d.state==='inQueue').length;
		const talk=staff.filter(a=>a.state==='busy').length;
		const acw=[...dots].filter(d=>d.state==='inACW'||d.state==='toACW').length;
		logs.arrivals.push(tmpMinute.arrivals);
		logs.q.push(q); logs.talk.push(talk); logs.acw.push(acw);
		logs.answered.push(tmpMinute.answered);
		logs.answeredInT.push(tmpMinute.answeredInT);
		logs.completed.push(tmpMinute.completed);
		logs.staffActive.push(NActive);
		const occ=tmpMinute.activeAgentsTime>0?(tmpMinute.busyAgentsTime/tmpMinute.activeAgentsTime):0; logs.occ.push(occ);
		const asa=tmpMinute.answered? (tmpMinute.waitDur.reduce((a,b)=>a+b,0)/tmpMinute.answered)/60 : 0; logs.asaMin.push(asa);
		const aht=tmpMinute.finishedDur.length? (tmpMinute.finishedDur.reduce((a,b)=>a+b,0)/tmpMinute.finishedDur.length)/60 : (params.aht/60); logs.ahtMin.push(aht);
		const wait=tmpMinute.waitDur.length? (tmpMinute.waitDur.reduce((a,b)=>a+b,0)/tmpMinute.waitDur.length)/60 : 0; logs.waitMin.push(wait);
		tmpMinute.finishedDur.length=0; tmpMinute.waitDur.length=0; tmpMinute.busyAgentsTime=0; tmpMinute.activeAgentsTime=0; tmpMinute.arrivals=0; tmpMinute.answered=0; tmpMinute.answeredInT=0; tmpMinute.completed=0;
	}
	function updateCounters(){ labelQueue.textContent=`В очереди: ${[...dots].filter(d=>d.state==='inQueue').length}`; labelACW.textContent=`Пост-обработка: ${[...dots].filter(d=>d.state==='inACW'||d.state==='toACW').length}`; updateServiceLabel(); txtDoneNum.textContent=String(doneCount); }

	function step(realDt){
		if(!running) return; const simDt=realDt*baseScale*speedMul; const tEnd=simT+simDt; const ratePerSec=params.lambda/3600;
		while(nextArrival<=tEnd){ spawnToQueue(); nextArrival=(nextArrival||simT)+Math.max(1,rndExp(1/ratePerSec)); }
		const moveSpeed=120;
		dots.forEach(d=>{
			if(d.state==='toQueue'||d.state==='toService'||d.state==='toACW'){
				const dx=d.target.x-d.x, dy=d.target.y-d.y, dist=Math.hypot(dx,dy), stepLen=Math.min(dist,moveSpeed*simDt);
				if(dist<=1){
					if(d.state==='toQueue'){d.state='inQueue'; d.enterQueueAt=simT;}
					else if(d.state==='toService'){d.state='inService'; d.enterServiceAt=simT; const wt=d.enterServiceAt-d.enterQueueAt; tmpMinute.waitDur.push(wt); tmpMinute.answered++; if(wt<=params.thr) tmpMinute.answeredInT++;}
					else if(d.state==='toACW'){d.state='inACW'; d.enterACWAt=simT;}
					d.x=d.target.x; d.y=d.target.y;
				} else { d.x+=(dx/dist)*stepLen; d.y+=(dy/dist)*stepLen; }
				d.el.setAttribute('cx',d.x); d.el.setAttribute('cy',d.y);
			}
		});
		staff.forEach(ag=>{
			if(ag.state==='busy'){
				tmpMinute.busyAgentsTime+=Math.min(simDt,Math.max(0,ag.busyUntil-simT));
				if(simT+simDt>=ag.busyUntil){
					const d=[...dots].find(o=>o.assigned===ag&&o.state==='inService');
					if(d){ d.state='toACW'; d.el.setAttribute('fill',areas.acw.color); d.target={x:areas.acw.x+10+Math.random()*(areas.acw.w-20),y:areas.acw.y+10+Math.random()*(areas.acw.h-20)}; d.leaveServiceAt=ag.busyUntil; tmpMinute.finishedDur.push(d.leaveServiceAt-d.enterServiceAt); }
					ag.state='acw'; ag.acwUntil=ag.busyUntil+Math.max(1,rndExp(params.acw||1));
				}
			} else if(ag.state==='acw'){
				if(simT+simDt>=ag.acwUntil){
					const d=[...dots].find(o=>o.assigned===ag&&(o.state==='inACW'||o.state==='toACW'));
					if(d){ d.el.remove(); dots.delete(d); doneCount++; tmpMinute.completed++; }
					ag.state='idle';
				}
			}
			if(ag.state!=='break'){ tmpMinute.activeAgentsTime+=simDt; }
		});
		while(tryAssign()){} if(tEnd>=nextLogAt){ minuteLog(); nextLogAt+=60; } simT=tEnd; updateCounters();
	}

	function loop(ts){ if(!lastTs) lastTs=ts; const realDt=Math.min(0.1,(ts-lastTs)/1000); lastTs=ts; if(running){ step(realDt); if(useBackend){ backendAccum+=realDt; if(backendAccum>=0.25){ api('/api/step',{ method:'POST', body: JSON.stringify({ dt: backendAccum, speed: speedMul })}).catch(()=>{}); backendAccum=0; } } } requestAnimationFrame(loop); } requestAnimationFrame(loop);

	['#inpLambda','#inpAHT','#inpACW','#inpSLA','#inpThresh','#inpOccMax','#inpShrink','#inpN'].forEach(id=>{ $(id).addEventListener('change',()=>{ if(!running) setParamsFromInputs(); }); });
	$('#speed').addEventListener('click',(e)=>{ const btn=e.target.closest('.chip'); if(!btn) return; document.querySelectorAll('.speed .chip').forEach(n=>n.classList.remove('active')); btn.classList.add('active'); speedMul=+btn.dataset.speed; });
	$('#btnStart').addEventListener('click',async()=>{ if(running) return; Object.values(logs).forEach(a=>Array.isArray(a)&&a.splice(0,a.length));
		tmpMinute.finishedDur.length=0; tmpMinute.waitDur.length=0; tmpMinute.busyAgentsTime=0; tmpMinute.activeAgentsTime=0; tmpMinute.arrivals=0; tmpMinute.answered=0; tmpMinute.answeredInT=0; tmpMinute.completed=0;
		nextLogAt=60; dots.forEach(d=>d.el.remove()); dots.clear(); doneCount=0; simT=0; lastTs=0; nextArrival=0; document.getElementById('tableBox').style.display='none';
		if(useBackend){ try{ await api('/api/start',{ method:'POST', body: JSON.stringify(getParams()) }); backendAccum=0; }catch(e){ console.error(e); } }
		running=true; });
	$('#btnStop').addEventListener('click',async()=>{ if(!running) return; running=false; try{ let srvLogs=null; if(useBackend){ const data=await api('/api/results'); srvLogs=data.logs; } buildTable(srvLogs); } finally { document.getElementById('tableBox').style.display='block'; } });
	$('#btnReset').addEventListener('click',async()=>{ running=false; dots.forEach(d=>d.el.remove()); dots.clear(); doneCount=0; simT=0; nextArrival=0; lastTs=0; Object.values(logs).forEach(a=>Array.isArray(a)&&a.splice(0,a.length)); document.getElementById('tableBox').style.display='none'; updateCounters(); if(useBackend){ try{ await api('/api/reset',{ method:'POST', body: JSON.stringify(getParams()) }); }catch(e){ console.error(e);} } });

	setParamsFromInputs(); buildStaff(); updateCounters();

	function buildTable(){
		const tbody=document.querySelector('#tbl tbody'); tbody.innerHTML=''; const rows=[];
		for(let i=0;i<logs.t.length;i++){
			const time=fmtHM(logs.t[i]), arr=logs.arrivals[i]||0, q=logs.q[i]||0, talk=logs.talk[i]||0, acw=logs.acw[i]||0;
			const ans=logs.answered[i]||0, ansT=logs.answeredInT[i]||0, comp=logs.completed[i]||0;
			const asa=logs.asaMin[i]||0, aht=logs.ahtMin[i]||0, wait=logs.waitMin[i]||0, sla=ans>0?(ansT/ans*100):0;
			const staffA=logs.staffActive[i]||0, occPct=(logs.occ[i]||0)*100;
			const row=[time,arr,q,talk,acw,ans,ansT,comp,asa.toFixed(2),aht.toFixed(2),wait.toFixed(2),sla.toFixed(1),staffA,occPct.toFixed(1)];
			rows.push(row); const tr=document.createElement('tr'); row.forEach(v=>{ const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); }); tbody.appendChild(tr);
		}
		document.getElementById('rowsCount').textContent=`Строк: ${rows.length}`;
		document.getElementById('btnCsv').onclick=()=>{ const csv=toCSV([[
			'Время (сим.)','Пришло','В очереди','В разговоре','В пост-обработке','Отвечено','Отвечено ≤T','Завершено','ASA, мин','Средний AHT, мин','Среднее ожид., мин','Уровень сервиса, %','Активные сотрудники','Занятость, %'
		],...rows]);
			downloadBlob(new Blob([csv],{type:"text/csv;charset=utf-8"}),"cc-sim-metrics.csv"); };
		document.getElementById('btnXlsx').onclick=()=>{ const header=['Время (сим.)','Пришло','В очереди','В разговоре','В пост-обработке','Отвечено','Отвечено ≤T','Завершено','ASA, мин','Средний AHT, мин','Среднее ожид., мин','Уровень сервиса, %','Активные сотрудники','Занятость, %'];
			const ws=XLSX.utils.aoa_to_sheet([header,...rows]); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Metrics"); const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
			downloadBlob(new Blob([wbout],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),"cc-sim-metrics.xlsx"); };
	}
	function toCSV(rows){ return rows.map(r=>r.map(x=>{ const s=String(x??""); return /[",;\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s; }).join(";")).join("\n"); }
	function downloadBlob(blob, filename){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0); }
})();
</script>
</body>
</html>
